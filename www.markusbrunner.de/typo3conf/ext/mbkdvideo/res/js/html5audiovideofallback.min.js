/* 
	HTML5AudioVideoFallback by Katja Deutschmann <http://www.katjadeutschmann.de/>, Default-Flash-Player for video fallback powered by Flowplayer (http://flowplayer.org/)
	
	@version: 						1.0
	@dependencies: 					jQuery <http://jquery.com>, 
									swfobject 2.2 <http://code.google.com/p/swfobject/>, 
									enablehtml5.js (or something else enabling older browsers to interprete HTML5 media tags correctly)
	
	This jQuery plugin creates a fallback for HTML5 video or audios. As fallback the video/audio is played with a flash player embedded using swfobject. If that is not possible download links will be provided.

	@param idPrefix: 				A string prefix for the id of the flash container/object. A timestamp will be added.
	@param flashPlayerSrc: 			The file path to the flash player (relative to the calling HTML file).
	@param flashExpressInstallSrc: 	The file path to the expressinstall.swf (relative to the calling HTML file).
	@param initFunction: 			The name of the initializing function for the flash player (if there is one).
	@param width: 					The width of the audio flash player if the width is not provided as attribute of video or medium type is audio. Default: 600px
	@param height: 					The height of the audio flash player if the height is not provided as attribute of videoor medium type is audio. Default: 400px
	@param flashMediumSrcType: 		The mimetype of the video/audio source that shall be used for the flash player. (e.g. video/mp4, video/ogg, video/webm, video/x-flv, audio/mpeg, audio/ogg)
									The video/audio source has to be a <source> in your list of HTML5 video/audio sources.
									Please assure your flash player is able to play the file type.
	@param flashVersion: 			The flash version to use.
	@param flashvars: 				The flashvars for the flash player. You can use these placeholders (see below): 
									###MEDIUM_SRC###, ###VIDEO_POSTER_SRC###, ###FLASH_ID###
	@param params: 					The params for the flash player. You can use these placeholders (see below): 
									###MEDIUM_SRC###, ###VIDEO_POSTER_SRC###, ###FLASH_ID###
	@param attributes: 				The attributes for the flash player. You can use these placeholders (see below): ###MEDIUM_SRC###, ###VIDEO_POSTER_SRC###, ###FLASH_ID###
	@param alternateMessageHTML: 	A HTML message that shall be shown in case flash cannot be embedded. You can use these placeholders (see below): 
									###ALTERNATE_MESSAGE_LINKS###, ###VIDEO_POSTER_SRC###
	@param alternateMessageLink: 	The HTML structure used for a link displayed in the alternateMessageHTML. You can use these placeholders (see below): 
									###MEDIUM_SRC###, ###MEDIUM_SRC_FILENAME###, ###MEDIUM_MIMETYPE###
	@param alwaysUseFlash:			Use flash instead of native HTML5 audio/video if true. Default: false.
	
	The following placeholders will be replaced by: 									
	###MEDIUM_SRC###: 				The file path to the medium source.
	###MEDIUM_SRC_FILENAME###: 		The file name of the medium source.
	###MEDIUM_MIMETYPE###: 			The mimetype of the medium source.
	###VIDEO_POSTER_SRC###:			The file path to the poster source of a video.
	###FLASH_ID###: 				The id of the flash container/object.
	###ALTERNATE_MESSAGE_LINKS###: 	A list of links to the video/audio sources for the alternate HTML message. Eech link follows the pattern specified by alternateMessageLink.
	
	Function call: 
	$('myElement').HTML5AudioVideoFallback();

	Know issues:
	- Doesn't work in Safari Windows unless QuickTime is installed due to Safari insists on finding no source tags (native HTML5 does not work either in that case)
*/
(function(a){a.fn.HTML5AudioVideoFallback=function(k){var o={idPrefix:"HTML5AudioVideoFallback_",flashPlayerSrc:"lib/flowplayer/flowplayer-3.2.7.swf",flashExpressInstallSrc:"lib/expressinstall.swf",flashVersion:"9",initFunction:null,width:600,height:400,flashMediumSrcType:"video/mp4",flashvars:"",attributes:"",params:"{\"flashvars\": \"config={'clip': {'url': '###MEDIUM_SRC###', 'autoPlay': 0}, 'canvas': {'backgroundColor': '#000000', 'backgroundImage': '###VIDEO_POSTER_SRC###'}}\"}",alternateMessageHTML:'<div><p>Unable to play medium. Please use download links provided:</p><ul class="linklist">###ALTERNATE_MESSAGE_LINKS###</ul></div>',alternateMessageLink:'<li><a href="###MEDIUM_SRC###">###MEDIUM_SRC_FILENAME###</a> (###MEDIUM_MIMETYPE###)</li>',alwaysUseFlash:false};var d="video";var l="audio";var c="video/ogg";var m="video/mp4";var j="video/webm";var f="audio/ogg";var h="video/x-flv";var i="audio/x-m4a";var e="audio/mpeg";var b="audio/wav";var g="audio/webm";var n={video:{ogg:c,ogv:c,avi:m,mp4:m,mkv:m,h264:m,"264":m,avc:m,m4v:m,"3gp":m,"3gpp":m,"3g2":m,mpg:m,mpeg:m,flv:h,webm:j},audio:{ogg:f,oga:f,aac:i,m4a:i,mp3:e,wav:b,webm:g}};if(o){a.extend(o,k)}return this.each(function(){var D=(this.nodeName.toLowerCase()==l)?l:d;var r=a(this);var t=r.children("source");if(t.length==0){t=[r]}var y=null;var G=false;var C=true;for(var A=0;A<t.length;A++){var H=a(t[A]).attr("src");var u=a(t[A]).attr("type");if(typeof u=="undefined"&&typeof H!="undefined"){u=n[D][H.split(".").slice(-1)[0]]}if(typeof u!="undefined"&&typeof H!="undefined"){if(u.match(o.flashMediumSrcType,"i")){y=H}C=false;if(this.load&&this.canPlayType){if(this.canPlayType(u)!=""){G=true;break}}}}if((!G||o.alwaysUseFlash)&&!C&&y!=null){var q=B(r.attr("poster"));y=B(y);var I=(typeof r.attr("width")=="undefined")?o.width:r.attr("width");var x=(typeof r.attr("height")=="undefined")?o.height:r.attr("height");var E=o.idPrefix+new Date().getTime();var s=a("<div/>",{id:E});r.replaceWith(s);if(o.initFunction!=null&&o.initFunction!=""&&typeof o.initFunction=="function"){o.initFunction.call()}var z=a.parseJSON(o.flashvars.replace("###FLASH_ID###",E).replace("###MEDIUM_SRC###",y).replace("###VIDEO_POSTER_SRC###",q));var F=a.parseJSON(o.params.replace("###FLASH_ID###",E).replace("###MEDIUM_SRC###",y).replace("###VIDEO_POSTER_SRC###",q));var v=a.parseJSON(o.attributes.replace("###FLASH_ID###",E).replace("###MEDIUM_SRC###",y).replace("###VIDEO_POSTER_SRC###",q));function p(J){if(!J.success){w()}else{r=jQuery(J.ref)}}swfobject.embedSWF(o.flashPlayerSrc,E,I,x,o.flashVersion,o.flashExpressInstallSrc,z,F,v,p)}else{if(!G&&y==null){w()}}function w(){var J="";a.each(t,function(N,O){var P=a(O).attr("src");var L=a(O).attr("type");if(typeof P!="undefined"){var M=o.alternateMessageLink.replace("###MEDIUM_SRC###",P).replace("###MEDIUM_SRC_FILENAME###",P.substring(P.lastIndexOf("/")+1));if(typeof L!="undefined"){M=M.replace("###MEDIUM_MIMETYPE###",L)}else{M=M.replace("###MEDIUM_MIMETYPE###","")}J+=M}});var K=o.alternateMessageHTML.replace("###ALTERNATE_MESSAGE_LINKS###",J).replace("###VIDEO_POSTER_SRC###",r.attr("poster"));if(typeof s!="undefined"){s.html(K)}else{r.replaceWith(K)}}function B(K){if(typeof K!="undefined"&&K!=null){if(K.charAt(0)=="/"){return document.location.protocol+"//"+document.location.host+K}else{if(K.indexOf("://")>0&&K.indexOf("://")<10){return K}else{if(a("base[href]").length>0){var J=a("base[href]").attr("href");if(J.charAt(J.length-1)!="/"){J+="/"}return J+K}else{return document.location.href.substring(0,document.location.href.lastIndexOf("/")+1)+K}}}}else{return null}}})}})(jQuery);